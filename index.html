<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oscar-Lucas Medrano</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      background: black;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .book-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .book {
      position: relative;
      box-shadow: 20px 20px 40px rgba(0, 0, 0, 0.4);
      background-color: black;
      overflow: hidden;
      width: 800px;
      height: 600px;
    }
    .book-content {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .book-cover-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      z-index: 10;
    }
    .book-cover {
      display: block;
      background: #333;
      border: none;
    }
    .book-cover canvas, .book-cover img {
      max-width: 400px;
      width: 100%;
      height: auto;
      object-fit: contain;
      border: none;
      margin: 0 auto;
    }
    .book.open .book-cover-wrapper {
      display: none;
    }
    .book-pages {
      position: absolute;
      display: none;
      flex-direction: row;
      align-items: center;
      width: 100%;
      height: 100%;
      z-index: 20;
      overflow: hidden;
      border: 2px dashed yellow;
    }
    .book.open .book-pages {
      display: flex;
    }
    .page {
      width: 50%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: auto;
      border: 1px solid green;
      position: relative;
      background: #f0f0f0;
    }
    .page iframe {
      max-width: 100%;
      max-height: 100%;
      border: none;
      background: transparent;
      display: block;
      z-index: 21;
    }
    .page canvas {
      max-width: 100%;
      max-height: 100%;
      border: none;
      display: block;
      z-index: 21;
    }
    .page .fallback-content {
      position: absolute;
      color: red;
      font-size: 24px;
      text-align: center;
      z-index: 22;
      background: #fff;
    }
    .page .fallback-link {
      position: absolute;
      color: blue;
      font-size: 18px;
      text-align: center;
      z-index: 23;
      text-decoration: underline;
    }
    .crease {
      width: 4px;
      height: 100%;
      background: linear-gradient(to right, rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.1));
      z-index: 24;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      visibility: visible;
    }
    @media (max-width: 768px) {
      .book {
        width: 80vw;
        height: auto;
        min-width: 0;
        min-height: 0;
      }
      .book-cover canvas, .book-cover img {
        max-width: 50vw;
        margin: 0 auto;
      }
      .book-pages {
        width: 80vw;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <div class="book-container">
    <div class="book">
      <div class="book-content">
        <div class="book-cover-wrapper">
          <div class="book-cover">
            <canvas id="cover-canvas"></canvas>
            <img id="cover-fallback" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" alt="Fallback Image" style="display: none;">
          </div>
        </div>
      </div>
      <div class="book-pages">
        <div class="crease"></div>
        <div class="page">
          <iframe id="about-pdf-iframe" src="about.pdf" type="application/pdf" width="100%" height="100%" frameborder="0" onload="console.log('About PDF iframe loaded')">
            <canvas id="about-pdf-canvas"></canvas>
            <div class="fallback-content">About (PDF Failed to Load)</div>
            <div class="fallback-link"><a href="about.pdf" target="_blank">Open About PDF</a></div>
          </iframe>
        </div>
        <div class="page">
          <iframe id="toc-pdf-iframe" src="table_of_contents.pdf" type="application/pdf" width="100%" height="100%" frameborder="0" onload="console.log('TOC PDF iframe loaded')">
            <canvas id="toc-pdf-canvas"></canvas>
            <div class="fallback-content">TOC (PDF Failed to Load)</div>
            <div class="fallback-link"><a href="table_of_contents.pdf" target="_blank">Open TOC PDF</a></div>
          </iframe>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="./pdf.mjs" onload="console.log('PDF.js script loaded successfully')" onerror="console.error('Failed to load PDF.js script:', event)"></script>
  <script type="module">
    import * as pdfjsLib from './pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.mjs';
    console.log('pdfjsLib initialized successfully');

    document.addEventListener('DOMContentLoaded', () => {
      const book = document.querySelector('.book');
      let currentPage = 0;

      if (!book) {
        console.error('Book element not found');
        return;
      }

      async function renderPDF(pdfUrl, canvasId, iframeId, fallbackId, scale = 2) {
        const canvas = document.getElementById(canvasId);
        const iframe = iframeId ? document.getElementById(iframeId) : null;
        const fallback = fallbackId ? document.getElementById(fallbackId) : null;
        if (!canvas) {
          console.error(`Canvas ${canvasId} not found`);
          if (fallback) fallback.style.display = 'block';
          return false;
        }
        const context = canvas.getContext('2d');
        context.fillStyle = 'transparent';
        context.fillRect(0, 0, 300, 400);
        try {
          const loadingTask = pdfjsLib.getDocument(pdfUrl);
          const pdf = await loadingTask.promise;
          const page = await pdf.getPage(1);
          const viewport = page.getViewport({ scale: scale });
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          await page.render({ canvasContext: context, viewport: viewport });
          console.log(`${canvasId} rendered successfully, size: ${canvas.width}x${canvas.height}`);
          canvas.style.display = 'block';
          if (iframe) iframe.style.display = 'none';
          if (fallback) fallback.style.display = 'none';
          return true;
        } catch (error) {
          console.error(`${canvasId} render failed:`, error.name, error.message, error.stack);
          canvas.style.display = 'none';
          if (iframe) iframe.style.display = 'block';
          if (fallback) fallback.style.display = 'block';
          console.log(`Showing fallback for ${canvasId} due to: ${error.message}`);
          return false;
        }
      }

      renderPDF('page1.pdf', 'cover-canvas', null, 'cover-fallback', 2).then(() => {
        setTimeout(() => {
          let maxHeight = document.getElementById('cover-canvas')?.height || document.getElementById('cover-fallback')?.height || 600;
          if (maxHeight === 0) {
            maxHeight = 600;
            console.warn('No valid canvas or fallback height detected, using fallback 600');
          }
          book.style.height = `${maxHeight}px`;
          document.querySelector('.book-content').style.height = `${maxHeight}px`;
          document.querySelector('.book-pages').style.height = `${maxHeight}px`;
          if (window.innerWidth <= 768) {
            const coverCanvas = document.getElementById('cover-canvas');
            const coverFallback = document.getElementById('cover-fallback');
            if (coverCanvas) coverCanvas.style.maxWidth = `50vw !important`;
            if (coverFallback) coverFallback.style.maxWidth = `50vw !important`;
            console.log(`Mobile cover adjusted to 50vw x ${maxHeight}px`);
          }
          console.log(`Book height set to ${maxHeight}px, cover-wrapper display: ${getComputedStyle(document.querySelector('.book-cover-wrapper')).display}, book-pages display: ${getComputedStyle(document.querySelector('.book-pages')).display}`);
          updatePageDisplay();
        }, 200);
      }).catch(error => console.error('Cover PDF rendering failed (outer):', error));

      async function updatePageDisplay() {
        console.log('Updating page display, currentPage:', currentPage);
        book.classList.toggle('open', currentPage > 0);
        const coverWrapper = document.querySelector('.book-cover-wrapper');
        const pages = document.querySelectorAll('.page');
        const creases = document.querySelectorAll('.crease');
        const aboutPdfIframe = document.getElementById('about-pdf-iframe');
        const tocPdfIframe = document.getElementById('toc-pdf-iframe');
        console.log(`Cover wrapper display: ${getComputedStyle(coverWrapper).display}, Pages found: ${pages.length}, Creases found: ${creases.length}, Open class: ${book.classList.contains('open')}, About PDF display: ${aboutPdfIframe ? getComputedStyle(aboutPdfIframe).display : 'null'}, TOC PDF display: ${tocPdfIframe ? getComputedStyle(tocPdfIframe).display : 'null'}`);
        if (currentPage === 0) {
          coverWrapper.style.display = 'flex';
          document.querySelector('.book-pages').style.display = 'none';
          console.log('Displaying cover, hiding pages');
        } else if (currentPage === 1 && pages.length >= 2) {
          coverWrapper.style.display = 'none';
          const bookPages = document.querySelector('.book-pages');
          bookPages.style.display = 'flex';
          for (const page of pages) {
            page.style.display = 'flex';
            const iframe = page.querySelector('iframe');
            const canvas = page.querySelector('canvas');
            if (iframe && canvas) {
              console.log(`Processing page with iframe: ${iframe.id}, canvas: ${canvas.id}, currentPage: ${currentPage}`);
              const pdfUrl = iframe.id === 'about-pdf-iframe' ? 'about.pdf' : 'table_of_contents.pdf';
              try {
                const success = await renderPDF(pdfUrl, canvas.id, iframe.id, page.querySelector('.fallback-content'), 1.5);
                console.log(`Render for ${canvas.id} completed, success: ${success}`);
                if (success) {
                  canvas.style.display = 'block';
                  iframe.style.display = 'none';
                } else {
                  canvas.style.display = 'none';
                  iframe.style.display = 'block';
                }
              } catch (error) {
                console.error(`Render failed for ${canvas.id}:`, error);
                canvas.style.display = 'none';
                iframe.style.display = 'block';
              }
            }
            page.style.display = page === pages[0] || page === pages[1] ? 'flex' : 'none';
          }
          creases.forEach((crease, index) => crease.style.display = index === 0 ? 'block' : 'none');
          console.log('Displaying pages 0 (About) and 1 (TOC) with crease 1');
        }
      }

      book.addEventListener('click', async (e) => {
        const rect = book.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        console.log('Click detected at:', clickX, 'within rect:', JSON.stringify(rect), 'currentPage before:', currentPage);

        if (clickX > 0) {
          currentPage = Math.min(1, currentPage + 1);
          console.log('Advanced to page:', currentPage);
        } else if (currentPage > 0 && clickX < rect.width * 0.3) {
          currentPage = Math.max(0, currentPage - 1);
          console.log('Switched back, currentPage:', currentPage);
        }
        console.log('currentPage after:', currentPage, 'Calling updatePageDisplay');
        await updatePageDisplay();
      });

      document.addEventListener('keydown', async (e) => {
        if (e.key === 'ArrowLeft' && currentPage > 0) {
          currentPage = Math.max(0, currentPage - 1);
          console.log('ArrowLeft, currentPage:', currentPage);
          await updatePageDisplay();
        } else if (e.key === 'ArrowRight' && currentPage < 1) {
          currentPage = Math.min(1, currentPage + 1);
          console.log('ArrowRight, currentPage:', currentPage);
          await updatePageDisplay();
        }
      });

      setInterval(() => {
        const aboutPdfIframe = document.getElementById('about-pdf-iframe');
        const tocPdfIframe = document.getElementById('toc-pdf-iframe');
        if (aboutPdfIframe) {
          console.log('About PDF status:', aboutPdfIframe.contentDocument ? 'loaded' : 'not loaded', 'display:', getComputedStyle(aboutPdfIframe).display, 'visibility:', getComputedStyle(aboutPdfIframe).visibility, 'onerror:', aboutPdfIframe.onerror ? 'error occurred' : 'no error', 'error:', aboutPdfIframe.error ? aboutPdfIframe.error : 'none');
        }
        if (tocPdfIframe) {
          console.log('TOC PDF status:', tocPdfIframe.contentDocument ? 'loaded' : 'not loaded', 'display:', getComputedStyle(tocPdfIframe).display, 'visibility:', getComputedStyle(tocPdfIframe).visibility, 'onerror:', tocPdfIframe.onerror ? 'error occurred' : 'no error', 'error:', tocPdfIframe.error ? tocPdfIframe.error : 'none');
        }
      }, 1000);
    });
  </script>
</body>
</html>
